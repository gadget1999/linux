#!/usr/bin/env bash

CMD_PATH=$(dirname "$0")
source $CMD_PATH/lib/common.sh
source $CMD_PATH/lib/docker.sh

CONTAINER="openvas"
IMAGE="mikesplain/openvas"

#########################
# Helper functions
#########################

function update_NVD() {
 local DOCKER_CMD="docker exec $CONTAINER"
 
 $DOCKER_CMD greenbone-nvt-sync
 $DOCKER_CMD openvasmd --rebuild --progress
 $DOCKER_CMD greenbone-certdata-sync
 $DOCKER_CMD greenbone-scapdata-sync
 $DOCKER_CMD openvasmd --update --verbose --progress
 $DOCKER_CMD /etc/init.d/openvas-manager restart
 $DOCKER_CMD /etc/init.d/openvas-scanner restart
}

function start_openvas() {
 local run_vol=/tmp/$CONTAINER

 [ ! -d $run_vol ] && mkdir $run_vol

 EXTRA_OPTS=(
  -v $run_vol:/var/run/redis
  -v $CONTAINER:/var/lib/openvas/mgr/
  -p 443:443
  )

 ENTRYPOINT=()

 new_container $CONTAINER $IMAGE "stateless" "background" EXTRA_OPTS ENTRYPOINT

 docker logs -f $CONTAINER
}

#########################
# Main entrance
#########################

case $1 in
 update)
  update_NVD
  ;;
 stop)
  stop_container openvas
  ;;
 debug)
  DEBUG_POD=1
  start_openvas
  ;;
 *)
  start_openvas
  ;;
esac
