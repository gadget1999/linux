#!/usr/bin/env bash

CMD_PATH=$(dirname "$0")
source $CMD_PATH/lib/common.sh

check_packages "/usr/bin/unzip"

function conditional_copy() {
 local condition="$1"
 local src_folder=$2
 local dst_folder=$3

 # condition is to test if the command exists
 [ ! -x "$(command -v $condition)" ] && return

 log "Found command: $condition. Will copy related files."
 [ ! -d $dst_folder ] && $SUDO mkdir $dst_folder
 copy_files "$src_folder/*" $dst_folder
}

GITHUB_URL="https://github.com/gadget1999/linux/archive/master.zip"
TMP_ZIP=/tmp/master.zip
TMP_FOLDER=/tmp/linux-master
TMP_CMD_FOLDER=/tmp/linux-master/scripts
CMD_LIB=$CMD_PATH/lib

cd /tmp

rm $TMP_ZIP 2> /dev/null
wget -q $GITHUB_URL
if [ ! -f $TMP_ZIP ]; then
 log_error "Cannot find downloaded file $TMP_ZIP. Internet or github down?"
 exit 1
fi

unzip -qq -o $TMP_ZIP

if !(copy_file $TMP_CMD_FOLDER/update-cmds $CMD_PATH/update-cmds); then
 log "update-cmds was updated, >>>>>> restarting <<<<<<"
 $CMD_PATH/update-cmds
 exit 0
fi

copy_files "$TMP_CMD_FOLDER/*" $CMD_PATH

[ ! -d $CMD_LIB ] && $SUDO mkdir $CMD_LIB
copy_files "$TMP_CMD_FOLDER/lib/*" $CMD_LIB

conditional_copy pwsh $TMP_CMD_FOLDER/azure $CMD_PATH/azure
conditional_copy adb $TMP_CMD_FOLDER/android $CMD_PATH
conditional_copy docker $TMP_CMD_FOLDER/docker $CMD_PATH
conditional_copy mosquitto_sub $TMP_CMD_FOLDER/mqtt $CMD_PATH

$SUDO chmod +x $CMD_PATH/*

rm -R $TMP_FOLDER
rm $TMP_ZIP
